<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title></title>
	<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css" />
	<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css" />
	<link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css" />
	<link rel="stylesheet" href="/theme/dist/webvaloa.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.2/css/all.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="vue-pagination-2.min.js"></script>
</head>

<body>
	<header id="webvaloa">
		<div class="container grid-lg">
			<img src="/assets/img/webvaloa.svg" alt="Webvaloa" class="logo" />
			<nav>
				<ul>
					<li class="active">
						<a href="/articles.html" class="nav-link"><i class="fas fas-file"></i><span class="menu-title">Articles</span></a>
					</li>
					<li>
						<a href="pages/widgets.html" class="nav-link"><i class="link-icon mdi mdi-apple-safari"></i><span class="menu-title">Categories</span></a>
					</li>
					<li>
						<a href="#" class="nav-link"><i class="link-icon mdi mdi-atom"></i><span class="menu-title">Huge Menu</span><i class="menu-arrow"></i></a>
						<div class="submenu">
							<div class="col-group-wrapper row">
								<div class="col-group col-md-4">
									<div class="row">
										<div class="col-12">
											<p class="category-heading">Basic Elements</p>
										</div>
										<div class="col-md-6">
											<ul class="submenu-item">
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/accordions.html">Accordion</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/buttons.html">Buttons</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/badges.html">Badges</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/breadcrumbs.html">Breadcrumbs</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/dropdowns.html">Dropdown</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/modals.html">Modals</a></li>
											</ul>
										</div>
										<div class="col-md-6">
											<ul class="submenu-item">
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/progress.html">Progress bar</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/pagination.html">Pagination</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/tabs.html">Tabs</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/typography.html">Typography</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/tooltips.html">Tooltip</a></li>
											</ul>
										</div>
									</div>
								</div>
								<div class="col-group col-md-4">
									<div class="row">
										<div class="col-12">
											<p class="category-heading">Advanced Elements</p>
										</div>
										<div class="col-md-6">
											<ul class="submenu-item">
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/dragula.html">Dragula</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/carousel.html">Carousel</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/clipboard.html">Clipboard</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/context-menu.html">Context Menu</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/loaders.html">Loader</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/slider.html">Slider</a></li>
											</ul>
										</div>
										<div class="col-md-6">
											<ul class="submenu-item">
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/tour.html">Tour</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/popups.html">Popup</a></li>
												<li class="nav-item"><a class="nav-link" href="pages/ui-features/notifications.html">Notification</a></li>
											</ul>
										</div>
									</div>
								</div>
								<div class="col-group col-md-2">
									<p class="category-heading">Table</p>
									<ul class="submenu-item">
										<li class="nav-item"><a class="nav-link" href="pages/tables/basic-table.html">Basic Table</a></li>
										<li class="nav-item"><a class="nav-link" href="pages/tables/data-table.html">Data Table</a></li>
										<li class="nav-item"><a class="nav-link" href="pages/tables/js-grid.html">Js-grid</a></li>
										<li class="nav-item"><a class="nav-link" href="pages/tables/sortable-table.html">Sortable Table</a></li>
									</ul>
								</div>
								<div class="col-group col-md-2">
									<p class="category-heading">Icons</p>
									<ul class="submenu-item">
										<li class="nav-item"><a class="nav-link" href="pages/icons/flag-icons.html">Flag Icons</a></li>
										<li class="nav-item"><a class="nav-link" href="pages/icons/font-awesome.html">Font Awesome</a></li>
										<li class="nav-item"><a class="nav-link" href="pages/icons/simple-line-icon.html">Simple Line Icons</a></li>
										<li class="nav-item"><a class="nav-link" href="pages/icons/themify.html">Themify Icons</a></li>
									</ul>
								</div>
							</div>
						</div>
					</li>
					<li>
							<a href="pages/widgets.html" class="nav-link"><i class="link-icon mdi mdi-apple-safari"></i><span class="menu-title">Settings</span></a>
						</li>
				</ul>
			</nav>
		</div>
	</header>

	<div id="app" class="container grid-lg">

		<!--<div class="toast toast-success">
			<button class="btn btn-clear float-right"></button>
			Successfully fucked up everything.
		</div>-->

		<div class="card" id="main-content">
			<div class="card-header">
				<input class="form-input float-right col-4" type="search" v-model="searchString" placeholder="Search articles">
				<div class="card-title h5">Articles</div>
				<div class="card-subtitle text-gray">Lists all articles in the database.</div>
			</div>
			<div class="card-body">
				<div class="loading loading-lg" v-if="loading"></div>
				<div class="content-wrapper" v-if="!loading">
					<div class="content">
						<ul class="tab tab-block">
							<li class="tab-item" v-for="category in categories">
								<a @click="setCategory(category.id)" v-bind:class="{ active: currentCategory == category.id }">{{category.name}}</a>
							</li>
						</ul>
						<div class="tab-content">
							<div class="articles">
								<div class="tile tile-centered" v-for="(article, index) in pagination" v-bind:key="index">
									<div class="tile-content">
										<div class="tile-title">{{article.title}}</div>
										<small class="tile-subtitle text-gray">{{article.owner}} · <span class="permission label label-rounded" v-for="permission of article.permission">{{(typeof roles[permission] === "object")?roles[permission].name:"?"}}</span> · {{article.created}}</small>
									</div>
									<div class="tile-action">
										<a :href="'/article/edit/' + article.id" class="btn btn-link">
											Edit
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="card-footer">
				<pagination v-bind:records="articleCount" v-model="page" v-bind:per-page="limit" ref="pagination"></pagination>
				<small class="text-gray" v-if="searchString!==''"> Searching for: "{{searchString}}"</small>
			</div>
		</div>
	</div>
</body>

<script>
	const app = new Vue({
		el: '#app',
		components: {
			Pagination
		},
		data: {
			page: 1,
			limit: 5,
			articleCount: 0,
			currentCategory: 0,
			articles: [],
			categories: [],
			roles: {},
			searchString: "",
			loading: false,
		},
		computed: {
			pagination() {
				const page = this.page - 1;
				let articles = [];
				if (this.searchString.length !== '') {
					const searchString = this.searchString.toLocaleLowerCase();
					articles = this.articles.filter(article => (article.title.toLocaleLowerCase().includes(searchString) || article.alias.toLocaleLowerCase().includes(searchString)));
				} else {
					articles = this.articles;
				}
				this.articleCount = articles.length;
				const slice = articles.slice(page * this.limit, (page + 1) * this.limit);
				return slice;
			}
		},
		methods: {
			fetchCategories: async () => {
				return fetch("/fake-api/categories.json")
					.then(res => {
						if (res.status !== 200) {
							throw Error("Server error while fetching categories.");
						}
						return res.json();
					})
			},
			fetchArticles: async categoryId => {
				return fetch(`/fake-api/category/${categoryId}.json`).then(res => {
					if (res.status !== 200) {
						throw Error("Server error while fetching articles.");
					}
					return res.json();
				})
			},
			fetchRoles: async () => {
				return fetch(`/fake-api/roles/roles.json`).then(res => {
					if (res.status !== 200) {
						throw Error("Server error while fetching roles.");
					}
					return res.json();
				})
			},
			async setCategory(id) {
				console.log(`Setting category to ${id}`);
				this.loading = true;
				try {
					this.page = 1;
					this.$refs.pagination.setPage(1);
					this.currentCategory = id;
					this.articles = await this.fetchArticles(this.currentCategory);
					this.loading = false;
				} catch (e) {
					console.error(e);
					alert(e);
					this.loading = false;
				}
			}
		},
		async created() {
			this.loading = true;
			try {
				this.page = 1;
				this.categories = await this.fetchCategories();
				if (this.categories.length === 0) {
					throw Error("No categories found");
				}
				this.currentCategory = this.categories[0].id;
				this.articles = await this.fetchArticles(this.currentCategory);
				this.roles = await this.fetchRoles();
				this.loading = false;
			} catch (e) {
				console.error(e);
				alert(e);
				this.loading = false;
			}
		}
	})
</script>


</html>